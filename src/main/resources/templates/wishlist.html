<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Wishlist | StyleLegacy</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/wishlist-styles.css">
</head>
<body>
<!-- Navigation Bar -->
<div th:replace="fragments/header-navbar :: navbar"></div>

<!-- Hero Section -->
<section class="hero-wishlist d-flex align-items-center">
    <div class="container position-relative z-2">
        <div class="row align-items-center">
            <div class="col-lg-8 mx-auto text-center text-white">
                <h1 class="display-4 fw-bold mb-3">
                    <i class="fas fa-heart me-3 text-pink"></i>Wishlist
                </h1>
                <p class="lead mb-0 opacity-75">
                    Your collection of favorite items, saved for later
                </p>
            </div>
        </div>
    </div>
</section>

<!-- Main Content -->
<div class="container my-5">
    <!-- Wishlist Header Card -->
    <div class="card wishlist-header shadow-lg border-0 mb-5">
        <div class="card-body p-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex align-items-center">
                        <div class="stats-card rounded-circle p-3 me-3" style="width: 60px; height: 60px;">
                            <i class="fas fa-heart text-danger fs-4"></i>
                        </div>
                        <div>
                            <h4 class="mb-1 fw-bold">Saved Items</h4>
                            <p class="text-muted mb-0" th:text="|${#lists.size(wishlistItems)} items in your wishlist|">
                                0 items in your wishlist</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <div class="d-flex flex-column flex-md-row gap-2 align-items-md-center justify-content-md-end">
                        <select class="form-select form-select-sm" id="sort-select" style="max-width: 200px;">
                            <option value="recent">Recently Added</option>
                            <option value="priceAsc">Price Low to High</option>
                            <option value="priceDesc">Price High to Low</option>
                            <option value="nameAsc">Name A-Z</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wishlist Content -->
    <div class="row">
        <!-- Empty Wishlist State -->
        <div class="col-12" th:if="${#lists.isEmpty(wishlistItems)}">
            <div class="empty-state d-flex align-items-center justify-content-center position-relative">
                <div class="text-center position-relative z-2 p-5">
                    <div class="mb-4">
                        <i class="fas fa-heart-broken text-muted" style="font-size: 5rem; opacity: 0.3;"></i>
                    </div>
                    <h3 class="fw-bold text-muted mb-3">Your wishlist is empty</h3>
                    <p class="text-muted mb-4 lead">
                        Discover amazing products and save your favorites here
                    </p>
                    <a th:href="@{/shop}" class="btn btn-dark btn-lg px-4">
                        <i class="fas fa-shopping-bag me-2"></i>Start Shopping
                    </a>
                </div>
            </div>
        </div>

        <!-- Wishlist Items Grid -->
        <div th:unless="${#lists.isEmpty(wishlistItems)}">
            <div class="row g-4" id="wishlist-items-container">
                <div class="col-lg-3 col-md-4 col-sm-6" th:each="item : ${wishlistItems}">
                    <div class="card product-card h-100 position-relative fade-in border">
                        <!-- Product Actions -->
                        <div class="product-actions">
                            <form class="wishlist-remove-form" th:action="@{/wishlist/remove}" method="post">
                                <input type="hidden" name="productId" th:value="${item.product.id}">
                                <button type="submit" class="action-btn remove" title="Remove from wishlist">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>

                        <!-- Product Link -->
                        <a th:href="@{'/products/' + ${item.product.id}}" class="text-decoration-none text-dark">
                            <img th:if="${item.product.image != null}"
                                 th:src="@{'/products/image/' + ${item.product.id}}"
                                 class="card-img-top"
                                 alt="Product Image"
                                 style="height: 350px; object-fit: cover;">
                            <img th:if="${item.product.image == null}"
                                 th:src="@{/images/default.png}"
                                 class="card-img-top"
                                 alt="Default Product Image"
                                 style="height: 350px; object-fit: cover;">
                        </a>

                        <div class="card-body d-flex flex-column">
                            <a th:href="@{'/products/' + ${item.product.id}}" class="text-decoration-none text-dark">
                                <h5 class="card-title mb-2" th:text="${item.product.productName}">Product Name</h5>
                            </a>
                            <p class="card-text text-muted small mb-2"
                               th:text="${item.product.subcategory?.subcategoryName}">Subcategory</p>
                            <p class="card-text text-muted small mb-2" th:text="${item.product.category?.categoryName}">
                                Category</p>
                            <div class="mt-auto">
                                <p class="fw-bold mb-1 fs-5" th:text="${item.product.formatPrice(item.product.price)} + ' USD'">$0.00</p>

                                <span class="badge bg-danger mt-2"
                                      th:if="${item.product.productSizes.?[stockQuantity > 0].isEmpty()}">
                                    Out of stock
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Actions -->
            <div class="row mt-5">
                <div class="col-12">
                    <div class="card border-0 bg-light">
                        <div class="card-body text-center p-4">
                            <h5 class="mb-3">Ready to make a purchase?</h5>
                            <div class="d-flex flex-column flex-sm-row gap-3 justify-content-center">
                                <a th:href="@{/shop}" class="btn btn-outline-dark btn-lg px-4">
                                    <i class="fas fa-plus me-2"></i>Continue Shopping
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:if="${currentUser != null and roleId == 2}">
    <div th:replace="fragments/chat :: chatWidget"></div>
</div>

<!-- Footer -->
<div th:replace="fragments/footer :: footer"></div>
<div th:replace="fragments/cart :: cart"></div>
<div th:replace="fragments/add-to-cart-notification :: add-to-cart-notification"></div>

<!-- Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script src="/js/script.js"></script>

<script>
    // Add smooth animations on page load
    document.addEventListener('DOMContentLoaded', function () {
        const cards = document.querySelectorAll('.product-card');
        cards.forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.wishlist-remove-form').forEach(form => {
            form.addEventListener('submit', function (e) {
                e.preventDefault();

                const productId = form.querySelector('input[name="productId"]').value;
                const productCard = form.closest('.col-lg-3');

                fetch('/wishlist/remove', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: `productId=${productId}`
                })
                    .then(response => {
                        if (!response.ok) throw new Error("Failed to remove");
                        return response.text();
                    })
                    .then(() => {
                        productCard.remove();
                        showToast("Removed from wishlist", "danger");

                        if (document.querySelectorAll('.product-card').length === 0) {
                            setTimeout(() => {
                                location.reload();
                            }, 1500); // Wait for toast to finish
                        }
                    })
                    .catch(err => {
                        console.error("❌ Error removing from wishlist:", err);
                        showToast("Failed to remove!", "warning");
                    });
            });
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const sortSelect = document.getElementById('sort-select');

        sortSelect.addEventListener('change', function () {
            const sortBy = this.value;

            fetch(`/wishlist/sort?sortBy=${sortBy}`, {
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
                .then(response => {
                    if (!response.ok) throw new Error("Failed to fetch sorted data");
                    return response.text();
                })
                .then(html => {
                    document.getElementById("wishlist-items-container").innerHTML = html;
                })
                .catch(err => {
                    console.error("❌ Error sorting:", err);
                    showToast("Failed to sort!", "warning");
                });
        });
    });
</script>

</body>
</html>